<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="SpendWise">
<meta name="theme-color" content="#0a0a0f">
<title>SpendWise</title>
<link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiU3BlbmRXaXNlIiwic2hvcnRfbmFtZSI6IlNwZW5kV2lzZSIsInN0YXJ0X3VybCI6Ii4iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjMGEwYTBmIiwidGhlbWVfY29sb3IiOiIjMGEwYTBmIn0=">
<style>
@import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&display=swap');
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{--bg:#0a0a0f;--surface:#14141f;--surface2:#1c1c2e;--surface3:#24243a;--border:#2a2a45;--text:#e8e8f0;--text2:#8888a8;--text3:#5a5a78;--accent:#6c5ce7;--accent2:#a29bfe;--green:#00b894;--red:#ff6b6b;--orange:#fdcb6e;--radius:16px;--radius-sm:10px;--safe-top:env(safe-area-inset-top,20px);--safe-bottom:env(safe-area-inset-bottom,0px)}
html,body{font-family:'DM Sans',-apple-system,sans-serif;background:var(--bg);color:var(--text);height:100%;overflow:hidden;overscroll-behavior:none}
body{position:fixed;width:100%}
.screen{position:absolute;top:0;left:0;right:0;bottom:0;display:none;flex-direction:column;overflow:hidden}.screen.active{display:flex}
.header{padding:calc(var(--safe-top)+8px) 20px 12px;background:var(--bg);z-index:10}
.header h1{font-family:'Space Mono',monospace;font-size:22px;font-weight:700;letter-spacing:-0.5px}
.header-sub{color:var(--text2);font-size:13px;margin-top:2px}
.scroll-area{flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;padding:0 16px 120px}
.budget-card{background:linear-gradient(135deg,#1a1a35,#14142a);border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin:12px 0 16px;position:relative;overflow:hidden}
.budget-card::after{content:'';position:absolute;top:-50%;right:-30%;width:200px;height:200px;background:radial-gradient(circle,rgba(108,92,231,.08),transparent 70%);pointer-events:none}
.budget-label{font-size:12px;color:var(--text3);text-transform:uppercase;letter-spacing:1px}
.budget-amount{font-family:'Space Mono',monospace;font-size:36px;font-weight:700;margin:6px 0 16px;letter-spacing:-1px}
.budget-amount.positive{color:var(--green)}.budget-amount.negative{color:var(--red)}.budget-amount.warning{color:var(--orange)}
.budget-bar-track{height:6px;background:var(--surface3);border-radius:3px;overflow:hidden;margin-bottom:12px}
.budget-bar-fill{height:100%;border-radius:3px;transition:width .6s,background .3s}
.budget-row{display:flex;justify-content:space-between;align-items:center;padding:4px 0}
.budget-row-label{font-size:13px;color:var(--text2)}.budget-row-value{font-family:'Space Mono',monospace;font-size:13px;font-weight:700}
.quick-stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:16px}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px}
.stat-icon{font-size:18px;margin-bottom:4px}.stat-label{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px}
.stat-value{font-family:'Space Mono',monospace;font-size:16px;font-weight:700;margin-top:2px}
.section-title{font-size:13px;color:var(--text3);text-transform:uppercase;letter-spacing:1px;margin:20px 0 10px}
.chart-container{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:14px}
.chart-toggle{display:flex;gap:4px;margin-bottom:12px}
.chart-toggle button{flex:1;padding:7px;border-radius:8px;font-size:11px;font-weight:600;border:1px solid var(--border);background:transparent;color:var(--text3);cursor:pointer;font-family:'DM Sans',sans-serif;transition:all .15s}
.chart-toggle button.active{background:var(--accent);border-color:var(--accent);color:#fff}
.cat-row{display:flex;align-items:center;padding:10px 0;gap:12px}
.cat-emoji{font-size:20px;width:28px;text-align:center}.cat-info{flex:1;min-width:0}.cat-name{font-size:13px;font-weight:500}
.cat-bar-track{height:4px;background:var(--surface3);border-radius:2px;margin-top:4px}
.cat-bar-fill{height:100%;border-radius:2px;transition:width .4s}
.cat-amount{font-family:'Space Mono',monospace;font-size:13px;color:var(--text2);white-space:nowrap}
.expense-item{display:flex;align-items:center;padding:12px 0;gap:12px;border-bottom:1px solid rgba(42,42,69,.5)}.expense-item:last-child{border-bottom:none}
.expense-emoji{font-size:24px;width:36px;text-align:center}.expense-info{flex:1;min-width:0}
.expense-name{font-size:14px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.expense-meta{font-size:12px;color:var(--text3);margin-top:2px}
.expense-amount{font-family:'Space Mono',monospace;font-size:15px;font-weight:700;color:var(--red);white-space:nowrap}.expense-amount.fixed{color:var(--text2)}
.expense-actions{display:flex;gap:8px}.expense-actions button{background:var(--surface3);border:none;color:var(--text2);width:30px;height:30px;border-radius:8px;font-size:14px;cursor:pointer}
.filter-tabs{display:flex;gap:6px;margin:12px 16px;overflow-x:auto;padding-bottom:4px;-webkit-overflow-scrolling:touch}.filter-tabs::-webkit-scrollbar{display:none}
.filter-tab{flex-shrink:0;padding:6px 14px;border-radius:20px;font-size:12px;font-weight:500;border:1px solid var(--border);background:transparent;color:var(--text2);cursor:pointer;transition:all .2s}
.filter-tab.active{background:var(--accent);border-color:var(--accent);color:white}
.amount-display{text-align:center;padding:24px 20px 16px}.amount-currency{font-size:20px;color:var(--text3)}
.amount-value{font-family:'Space Mono',monospace;font-size:48px;font-weight:700;letter-spacing:-2px;min-height:58px}.amount-value.empty{color:var(--text3)}
.category-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;padding:0 16px;margin-bottom:14px}
.cat-btn{display:flex;flex-direction:column;align-items:center;gap:4px;padding:10px 6px;background:var(--surface);border:2px solid var(--border);border-radius:var(--radius-sm);color:var(--text2);font-size:11px;font-weight:500;cursor:pointer;transition:all .15s}
.cat-btn .emoji{font-size:22px}.cat-btn.selected{border-color:var(--accent);background:rgba(108,92,231,.12);color:var(--text)}
.desc-input{margin:0 16px 10px;padding:12px 16px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-family:'DM Sans',sans-serif;font-size:14px;width:calc(100% - 32px);outline:none}
.desc-input::placeholder{color:var(--text3)}.desc-input:focus{border-color:var(--accent)}
.date-row{display:flex;gap:8px;padding:0 16px;margin-bottom:10px}
.date-btn{flex:1;padding:9px;background:var(--surface);border:2px solid var(--border);border-radius:var(--radius-sm);color:var(--text2);font-size:12px;font-weight:500;cursor:pointer;text-align:center}
.date-btn.selected{border-color:var(--accent);color:var(--text);background:rgba(108,92,231,.12)}
.numpad{display:grid;grid-template-columns:repeat(3,1fr);gap:5px;padding:6px 16px}
.num-key{height:48px;background:var(--surface);border:none;border-radius:var(--radius-sm);color:var(--text);font-family:'Space Mono',monospace;font-size:22px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center}
.num-key:active{background:var(--surface3)}.num-key.del{font-size:18px}
.settings-group{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:14px;overflow:hidden}
.settings-row{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid var(--border)}.settings-row:last-child{border-bottom:none}
.settings-label{font-size:14px}.settings-input{background:transparent;border:none;color:var(--accent2);font-family:'Space Mono',monospace;font-size:14px;text-align:right;width:120px;outline:none}
.fixed-expense-item{display:flex;align-items:center;padding:12px 16px;border-bottom:1px solid var(--border);gap:10px;cursor:pointer}.fixed-expense-item:last-child{border-bottom:none}
.fixed-expense-info{flex:1}.fixed-expense-name{font-size:14px;font-weight:500}.fixed-expense-detail{font-size:12px;color:var(--text3)}
.fixed-expense-amount{font-family:'Space Mono',monospace;font-size:14px;font-weight:700}
.btn-add-fixed{display:flex;align-items:center;justify-content:center;gap:6px;padding:12px;background:transparent;border:2px dashed var(--border);border-radius:var(--radius-sm);color:var(--text3);font-family:'DM Sans',sans-serif;font-size:13px;cursor:pointer;width:100%;margin-bottom:14px}
.sheets-url-input{width:100%;padding:12px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;outline:none;margin-bottom:8px}.sheets-url-input:focus{border-color:var(--accent)}
.sheets-status{font-size:12px;padding:6px 0}.sheets-status.connected{color:var(--green)}.sheets-status.disconnected{color:var(--text3)}
.btn-primary{width:100%;padding:14px;background:var(--accent);border:none;border-radius:var(--radius-sm);color:white;font-family:'DM Sans',sans-serif;font-size:14px;font-weight:600;cursor:pointer;margin-top:8px}
.btn-danger{background:transparent;border:1px solid var(--red);color:var(--red)}
.upload-zone{border:2px dashed var(--border);border-radius:var(--radius);padding:24px 16px;text-align:center;cursor:pointer;margin-bottom:14px}
.upload-zone:active{border-color:var(--accent)}
.upload-zone .big-emoji{font-size:32px;display:block;margin-bottom:8px}
.upload-zone p{font-size:13px;color:var(--text3);line-height:1.5}.upload-zone .hl{color:var(--accent2);font-weight:600}
.upload-preview{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px 16px;margin-bottom:10px;font-size:13px;max-height:200px;overflow-y:auto;display:none}
.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);z-index:100;display:none;align-items:flex-end;justify-content:center}
.modal-overlay.show{display:flex}
.modal{background:var(--surface);border-radius:var(--radius) var(--radius) 0 0;width:100%;max-width:430px;padding:24px 20px calc(var(--safe-bottom)+20px);max-height:80vh;overflow-y:auto}
.modal h3{font-size:18px;margin-bottom:16px}
.modal-input{width:100%;padding:12px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-family:'DM Sans',sans-serif;font-size:14px;outline:none;margin-bottom:10px}.modal-input:focus{border-color:var(--accent)}
.modal-row{display:flex;gap:10px}
.nav-bar{position:fixed;bottom:0;left:0;right:0;background:rgba(14,14,22,.92);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-top:1px solid var(--border);display:flex;padding:6px 0 calc(var(--safe-bottom)+6px);z-index:50}
.nav-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;padding:8px 0;background:none;border:none;color:var(--text3);font-size:10px;font-weight:500;cursor:pointer}.nav-item.active{color:var(--accent2)}
.nav-icon{font-size:22px;height:26px;display:flex;align-items:center}
.nav-item.add-btn .nav-icon{width:44px;height:44px;background:var(--accent);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:26px;color:white;margin-top:-18px;box-shadow:0 4px 20px rgba(108,92,231,.4)}
.toast{position:fixed;top:calc(var(--safe-top)+10px);left:50%;transform:translateX(-50%) translateY(-100px);background:var(--green);color:white;padding:10px 20px;border-radius:20px;font-size:13px;font-weight:600;z-index:200;transition:transform .3s;white-space:nowrap}
.toast.show{transform:translateX(-50%) translateY(0)}.toast.error{background:var(--red)}
.empty-state{text-align:center;padding:40px 20px;color:var(--text3)}.empty-state .emoji{font-size:48px;margin-bottom:12px}
.donut-wrapper{position:relative;display:flex;justify-content:center}
.donut-center{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;pointer-events:none}
.donut-center .val{font-family:'Space Mono',monospace;font-size:20px;font-weight:700}
.donut-center .lbl{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px}
.chart-legend{display:flex;flex-wrap:wrap;gap:6px 14px;margin-top:12px}
.legend-item{display:flex;align-items:center;gap:5px;font-size:11px;color:var(--text2)}
.legend-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
</style>
</head>
<body>
<div class="toast" id="toast"></div>

<!-- DASHBOARD -->
<div class="screen active" id="screen-dashboard">
<div class="header"><h1>SpendWise</h1><div class="header-sub" id="month-label"></div></div>
<div class="scroll-area">
<div class="budget-card animate-in">
<div class="budget-label">Remaining Budget</div>
<div class="budget-amount" id="remaining-amount">S$0.00</div>
<div class="budget-bar-track"><div class="budget-bar-fill" id="budget-bar"></div></div>
<div class="budget-row"><span class="budget-row-label">Income</span><span class="budget-row-value" id="income-display" style="color:var(--green)">S$0.00</span></div>
<div class="budget-row"><span class="budget-row-label">Fixed Expenses</span><span class="budget-row-value" id="fixed-display" style="color:var(--text2)">S$0.00</span></div>
<div class="budget-row"><span class="budget-row-label">Variable Spent</span><span class="budget-row-value" id="variable-display" style="color:var(--red)">S$0.00</span></div>
</div>
<div class="quick-stats">
<div class="stat-card"><div class="stat-icon">üìÖ</div><div class="stat-label">Today</div><div class="stat-value" id="today-spent">S$0</div></div>
<div class="stat-card"><div class="stat-icon">üìä</div><div class="stat-label">Avg/Day</div><div class="stat-value" id="daily-avg">S$0</div></div>
<div class="stat-card"><div class="stat-icon">üî¢</div><div class="stat-label">Txns</div><div class="stat-value" id="txn-count">0</div></div>
</div>
<div class="section-title">Spending Trend</div>
<div class="chart-container">
<div class="chart-toggle" id="trend-toggle"><button class="active" onclick="setTrendView('weekly',this)">Weekly</button><button onclick="setTrendView('monthly',this)">Monthly</button></div>
<canvas id="trend-chart" height="180"></canvas>
</div>
<div class="section-title">Category Breakdown</div>
<div class="chart-container">
<div class="donut-wrapper"><canvas id="donut-chart" width="220" height="220" style="max-width:220px;max-height:220px"></canvas>
<div class="donut-center"><div class="val" id="donut-total">S$0</div><div class="lbl">Variable</div></div></div>
<div class="chart-legend" id="donut-legend"></div>
</div>
<div class="section-title">By Category</div>
<div id="category-breakdown"></div>
</div></div>

<!-- ADD -->
<div class="screen" id="screen-add">
<div class="header"><h1>Add Expense</h1></div>
<div class="scroll-area" style="padding-bottom:20px">
<div class="amount-display"><span class="amount-currency">S$</span><div class="amount-value empty" id="amount-display">0.00</div></div>
<div class="category-grid" id="category-grid"></div>
<input type="text" class="desc-input" id="desc-input" placeholder="Description (optional)" maxlength="50">
<div class="date-row"><button class="date-btn selected" id="date-today" onclick="selectDate('today')">Today</button><button class="date-btn" id="date-yesterday" onclick="selectDate('yesterday')">Yesterday</button><button class="date-btn" id="date-custom" onclick="selectDate('custom')">Pick</button></div>
<input type="date" id="custom-date" style="display:none;margin:0 16px 10px;width:calc(100% - 32px)" class="desc-input">
<div class="numpad">
<button class="num-key" onclick="numInput('1')">1</button><button class="num-key" onclick="numInput('2')">2</button><button class="num-key" onclick="numInput('3')">3</button>
<button class="num-key" onclick="numInput('4')">4</button><button class="num-key" onclick="numInput('5')">5</button><button class="num-key" onclick="numInput('6')">6</button>
<button class="num-key" onclick="numInput('7')">7</button><button class="num-key" onclick="numInput('8')">8</button><button class="num-key" onclick="numInput('9')">9</button>
<button class="num-key" onclick="numInput('.')">.</button><button class="num-key" onclick="numInput('0')">0</button><button class="num-key del" onclick="numDelete()">‚å´</button>
</div>
<div style="padding:8px 16px"><button class="btn-primary" onclick="saveExpense()">Save Expense</button></div>
</div></div>

<!-- HISTORY -->
<div class="screen" id="screen-history">
<div class="header"><h1>History</h1><div class="header-sub" id="history-month-label"></div></div>
<div class="filter-tabs" id="history-filters"></div>
<div class="scroll-area" style="padding-top:8px" id="history-list"></div>
</div>

<!-- SETTINGS -->
<div class="screen" id="screen-settings">
<div class="header"><h1>Settings</h1></div>
<div class="scroll-area" style="padding-top:12px">
<div class="section-title">Monthly Income</div>
<div class="settings-group"><div class="settings-row"><span class="settings-label">Income</span><input type="number" class="settings-input" id="income-input" placeholder="0.00" onchange="saveSettings()"></div></div>
<div class="section-title">Fixed Monthly Expenses</div>
<div class="settings-group" id="fixed-expenses-list"></div>
<button class="btn-add-fixed" onclick="showFixedModal()">+ Add Fixed Expense</button>

<div class="section-title">Import Past Expenses</div>
<div class="upload-zone" onclick="document.getElementById('csv-file').click()">
<span class="big-emoji">üìé</span>
<p>Tap to upload a <span class="hl">CSV file</span></p>
<p style="font-size:11px;margin-top:6px;color:var(--text3)">Format: Date, Amount, Category, Description<br>Date as YYYY-MM-DD or DD/MM/YYYY</p>
</div>
<input type="file" id="csv-file" accept=".csv,.txt" style="display:none" onchange="handleCSV(event)">
<div class="upload-preview" id="upload-preview"></div>
<button class="btn-primary" id="import-btn" style="display:none;margin-bottom:14px" onclick="confirmImport()">Import Expenses</button>

<div class="section-title">Google Sheets Sync</div>
<div class="settings-group" style="padding:14px 16px">
<p style="font-size:12px;color:var(--text3);margin-bottom:10px">Paste your Google Apps Script Web App URL.</p>
<input type="url" class="sheets-url-input" id="sheets-url" placeholder="https://script.google.com/macros/s/..." onchange="saveSheetsUrl()">
<div class="sheets-status disconnected" id="sheets-status">Not connected</div>
<button class="btn-primary" onclick="testSheets()" style="margin-top:4px">Test Connection</button>
<button class="btn-primary" onclick="syncAll()" style="margin-top:8px;background:var(--green)">Sync All Data</button>
</div>
<div class="section-title">Data</div>
<div class="settings-group"><div class="settings-row" style="cursor:pointer" onclick="exportCSV()"><span class="settings-label">üì• Export as CSV</span><span style="color:var(--accent2)">‚Üí</span></div></div>
<button class="btn-primary btn-danger" onclick="clearData()" style="margin-bottom:40px">Clear All Data</button>
</div></div>

<!-- NAV -->
<nav class="nav-bar">
<button class="nav-item active" onclick="showScreen('dashboard')"><span class="nav-icon">üìä</span>Dashboard</button>
<button class="nav-item" onclick="showScreen('history')"><span class="nav-icon">üìã</span>History</button>
<button class="nav-item add-btn" onclick="showScreen('add')"><span class="nav-icon">+</span></button>
<button class="nav-item" onclick="showScreen('settings')"><span class="nav-icon">‚öôÔ∏è</span>Settings</button>
</nav>

<!-- MODALS -->
<div class="modal-overlay" id="fixed-modal"><div class="modal">
<h3 id="fm-title">Add Fixed Expense</h3>
<input type="text" class="modal-input" id="fm-name" placeholder="Name (e.g., Rent)">
<input type="number" class="modal-input" id="fm-amount" placeholder="Amount (S$)">
<select class="modal-input" id="fm-cat"></select>
<input type="number" class="modal-input" id="fm-due" placeholder="Due date (1-31)" min="1" max="31">
<div class="modal-row"><button class="btn-primary" onclick="saveFixed()" id="fm-save">Add</button><button class="btn-primary btn-danger" onclick="closeModal('fixed-modal')" style="flex:.5">Cancel</button></div>
<button class="btn-primary btn-danger" id="fm-del" style="display:none;margin-top:8px" onclick="deleteFixed()">Delete</button>
</div></div>

<div class="modal-overlay" id="edit-modal"><div class="modal">
<h3>Edit Expense</h3>
<input type="number" class="modal-input" id="em-amount" placeholder="Amount (S$)">
<input type="text" class="modal-input" id="em-desc" placeholder="Description">
<select class="modal-input" id="em-cat"></select>
<div class="modal-row"><button class="btn-primary" onclick="saveEdit()">Save</button><button class="btn-primary btn-danger" onclick="closeModal('edit-modal')" style="flex:.5">Cancel</button></div>
</div></div>

<script>
const CATS=[
{id:'food',name:'Food & Dining',emoji:'üçú',color:'#ff6b6b'},
{id:'transport',name:'Transport',emoji:'üöå',color:'#feca57'},
{id:'groceries',name:'Groceries',emoji:'üõí',color:'#00b894'},
{id:'entertainment',name:'Entertainment',emoji:'üéÆ',color:'#a29bfe'},
{id:'shopping',name:'Shopping',emoji:'üõçÔ∏è',color:'#fd79a8'},
{id:'coffee',name:'Coffee/Drinks',emoji:'‚òï',color:'#e17055'},
{id:'health',name:'Health',emoji:'üíä',color:'#00cec9'},
{id:'utilities',name:'Utilities/Bills',emoji:'üí°',color:'#6c5ce7'},
{id:'memberships',name:'Memberships',emoji:'üèãÔ∏è',color:'#fdcb6e'}
];
const CM={};CATS.forEach(c=>CM[c.id]=c);

// STATE
let S={income:0,fixedExpenses:[],expenses:[],sheetsUrl:''};
function load(){try{const s=localStorage.getItem('sw');if(s)S={...S,...JSON.parse(s)}}catch(e){}}
function save(){localStorage.setItem('sw',JSON.stringify(S))}
function fmt(n){return'S$'+Number(n).toFixed(2)}
function today(){return new Date().toISOString().split('T')[0]}
function monthLabel(){return new Date().toLocaleDateString('en-SG',{month:'long',year:'numeric'})}
function monthExps(){const now=new Date(),ym=now.getFullYear()+'-'+String(now.getMonth()+1).padStart(2,'0');return S.expenses.filter(e=>e.date&&e.date.startsWith(ym))}

// SCREENS
let curScreen='dashboard';
function showScreen(n){curScreen=n;document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById('screen-'+n).classList.add('active');document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active'));const m={dashboard:0,history:1,add:2,settings:3};if(m[n]!==undefined)document.querySelectorAll('.nav-item')[m[n]].classList.add('active');if(n==='dashboard')refreshDash();if(n==='history')refreshHist();if(n==='settings')refreshSet();if(n==='add')resetAdd()}
function toast(msg,err){const t=document.getElementById('toast');t.textContent=msg;t.className='toast'+(err?' error':'');setTimeout(()=>t.classList.add('show'),10);setTimeout(()=>t.classList.remove('show'),2500)}
function closeModal(id){document.getElementById(id).classList.remove('show')}

// DASHBOARD
let trendView='weekly';
function setTrendView(v,btn){trendView=v;document.querySelectorAll('#trend-toggle button').forEach(b=>b.classList.remove('active'));btn.classList.add('active');drawTrend()}

function refreshDash(){
document.getElementById('month-label').textContent=monthLabel();
const inc=S.income||0,fixT=S.fixedExpenses.reduce((s,e)=>s+Number(e.amount),0);
const me=monthExps(),varT=me.reduce((s,e)=>s+Number(e.amount),0),rem=inc-fixT-varT;
const el=document.getElementById('remaining-amount');el.textContent=fmt(rem);
el.className='budget-amount '+(rem>inc*.3?'positive':rem>0?'warning':'negative');
document.getElementById('income-display').textContent=fmt(inc);
document.getElementById('fixed-display').textContent=fmt(fixT);
document.getElementById('variable-display').textContent=fmt(varT);
const tot=fixT+varT,pct=inc>0?Math.min(tot/inc*100,100):0;
const bar=document.getElementById('budget-bar');bar.style.width=pct+'%';bar.style.background=pct>90?'var(--red)':pct>70?'var(--orange)':'var(--green)';
const td=today(),todT=me.filter(e=>e.date===td).reduce((s,e)=>s+Number(e.amount),0);
document.getElementById('today-spent').textContent=fmt(todT);
// Daily avg EXCLUDING fixed ‚Äî only variable / days elapsed
const dom=new Date().getDate();
document.getElementById('daily-avg').textContent=fmt(dom>0?varT/dom:0);
document.getElementById('txn-count').textContent=me.length;
drawTrend();drawDonut(me);drawCatBars(me);
}

// TREND CHART
function drawTrend(){
const c=document.getElementById('trend-chart'),ctx=c.getContext('2d'),dpr=window.devicePixelRatio||1;
const r=c.getBoundingClientRect();c.width=r.width*dpr;c.height=180*dpr;ctx.scale(dpr,dpr);
const W=r.width,H=180;ctx.clearRect(0,0,W,H);
let labels=[],vals=[];
if(trendView==='weekly'){
const now=new Date(),y=now.getFullYear(),m=now.getMonth(),dim=new Date(y,m+1,0).getDate();
const ym=y+'-'+String(m+1).padStart(2,'0'),me=S.expenses.filter(e=>e.date&&e.date.startsWith(ym));
for(let w=0;w<Math.ceil(dim/7);w++){const s=w*7+1,en=Math.min(s+6,dim);labels.push('W'+(w+1));let t=0;me.forEach(e=>{const d=parseInt(e.date.split('-')[2]);if(d>=s&&d<=en)t+=Number(e.amount)});vals.push(t)}
}else{
const now=new Date();for(let i=5;i>=0;i--){const d=new Date(now.getFullYear(),now.getMonth()-i,1),ym=d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0');labels.push(d.toLocaleDateString('en-SG',{month:'short'}));vals.push(S.expenses.filter(e=>e.date&&e.date.startsWith(ym)).reduce((s,e)=>s+Number(e.amount),0))}
}
if(vals.every(v=>v===0)){ctx.fillStyle='#5a5a78';ctx.font='13px DM Sans';ctx.textAlign='center';ctx.fillText('No data yet',W/2,H/2);return}
const mx=Math.max(...vals,1),pL=10,pR=10,pT=24,pB=32,cW=W-pL-pR,cH=H-pT-pB,bW=Math.min(cW/labels.length*.6,40),gap=cW/labels.length;
ctx.strokeStyle='#1c1c2e';ctx.lineWidth=1;for(let i=0;i<=3;i++){const y=pT+cH*(1-i/3);ctx.beginPath();ctx.moveTo(pL,y);ctx.lineTo(W-pR,y);ctx.stroke()}
vals.forEach((v,i)=>{const x=pL+gap*i+gap/2-bW/2,bH=(v/mx)*cH,y=pT+cH-bH;
const g=ctx.createLinearGradient(x,y,x,pT+cH);g.addColorStop(0,'#6c5ce7');g.addColorStop(1,'#4834d4');ctx.fillStyle=g;
const rad=Math.min(bW/2,6);ctx.beginPath();ctx.moveTo(x,pT+cH);ctx.lineTo(x,y+rad);ctx.arcTo(x,y,x+rad,y,rad);ctx.arcTo(x+bW,y,x+bW,y+rad,rad);ctx.lineTo(x+bW,pT+cH);ctx.closePath();ctx.fill();
if(v>0){ctx.fillStyle='#a29bfe';ctx.font='bold 10px Space Mono';ctx.textAlign='center';ctx.fillText('$'+Math.round(v),x+bW/2,y-6)}
ctx.fillStyle='#5a5a78';ctx.font='11px DM Sans';ctx.textAlign='center';ctx.fillText(labels[i],x+bW/2,H-8)});
}

// DONUT
function drawDonut(me){
const c=document.getElementById('donut-chart'),ctx=c.getContext('2d'),dpr=window.devicePixelRatio||1;
c.width=220*dpr;c.height=220*dpr;ctx.scale(dpr,dpr);
const sz=220,cx=sz/2,cy=sz/2,oR=95,iR=62;ctx.clearRect(0,0,sz,sz);
const ct={};me.forEach(e=>{ct[e.category]=(ct[e.category]||0)+Number(e.amount)});
const sorted=Object.entries(ct).sort((a,b)=>b[1]-a[1]),total=sorted.reduce((s,e)=>s+e[1],0);
document.getElementById('donut-total').textContent=fmt(total);
if(total===0){ctx.strokeStyle='#24243a';ctx.lineWidth=oR-iR;ctx.beginPath();ctx.arc(cx,cy,(oR+iR)/2,0,Math.PI*2);ctx.stroke();document.getElementById('donut-legend').innerHTML='';return}
let a=-Math.PI/2;let lg='';
sorted.forEach(([catId,val],i)=>{const cat=CM[catId]||{emoji:'üì¶',name:catId,color:'#6c5ce7'};const col=cat.color;const sl=(val/total)*Math.PI*2;
ctx.beginPath();ctx.moveTo(cx+Math.cos(a)*iR,cy+Math.sin(a)*iR);ctx.arc(cx,cy,oR,a,a+sl);ctx.arc(cx,cy,iR,a+sl,a,true);ctx.closePath();ctx.fillStyle=col;ctx.fill();ctx.strokeStyle='#14141f';ctx.lineWidth=2;ctx.stroke();
lg+=`<div class="legend-item"><span class="legend-dot" style="background:${col}"></span>${cat.emoji} ${Math.round(val/total*100)}%</div>`;a+=sl});
document.getElementById('donut-legend').innerHTML=lg;
}

function drawCatBars(me){
const ct={};me.forEach(e=>{ct[e.category]=(ct[e.category]||0)+Number(e.amount)});
S.fixedExpenses.forEach(e=>{ct[e.category]=(ct[e.category]||0)+Number(e.amount)});
const mx=Math.max(...Object.values(ct),1),sorted=Object.entries(ct).sort((a,b)=>b[1]-a[1]);
const el=document.getElementById('category-breakdown');
if(!sorted.length){el.innerHTML='<div class="empty-state"><div class="emoji">üì≠</div><p>No expenses yet.<br>Tap + to start!</p></div>';return}
el.innerHTML=sorted.map(([id,t])=>{const c=CM[id]||{emoji:'üì¶',name:id,color:'#6c5ce7'};return`<div class="cat-row"><span class="cat-emoji">${c.emoji}</span><div class="cat-info"><div class="cat-name">${c.name}</div><div class="cat-bar-track"><div class="cat-bar-fill" style="width:${t/mx*100}%;background:${c.color}"></div></div></div><span class="cat-amount">${fmt(t)}</span></div>`}).join('');
}

// ADD
let amtStr='',selCat='',dateMode='today';
function resetAdd(){amtStr='';selCat='';dateMode='today';updAmt();document.getElementById('desc-input').value='';document.getElementById('custom-date').style.display='none';document.querySelectorAll('.date-btn').forEach(b=>b.classList.remove('selected'));document.getElementById('date-today').classList.add('selected');renderCatGrid()}
function renderCatGrid(){document.getElementById('category-grid').innerHTML=CATS.map(c=>`<button class="cat-btn ${selCat===c.id?'selected':''}" onclick="pickCat('${c.id}')"><span class="emoji">${c.emoji}</span>${c.name.split(' ')[0]}</button>`).join('')}
function pickCat(id){selCat=id;renderCatGrid()}
function numInput(ch){if(ch==='.'&&amtStr.includes('.'))return;if(amtStr.includes('.')&&amtStr.split('.')[1].length>=2)return;if(amtStr.length>=10)return;amtStr+=ch;updAmt()}
function numDelete(){amtStr=amtStr.slice(0,-1);updAmt()}
function updAmt(){const el=document.getElementById('amount-display');if(!amtStr){el.textContent='0.00';el.classList.add('empty')}else{el.textContent=amtStr;el.classList.remove('empty')}}
function selectDate(m){dateMode=m;document.querySelectorAll('.date-btn').forEach(b=>b.classList.remove('selected'));document.getElementById('date-'+m).classList.add('selected');document.getElementById('custom-date').style.display=m==='custom'?'block':'none';if(m==='custom')document.getElementById('custom-date').value=today()}
function getDate(){if(dateMode==='today')return today();if(dateMode==='yesterday'){const d=new Date();d.setDate(d.getDate()-1);return d.toISOString().split('T')[0]}return document.getElementById('custom-date').value||today()}
function saveExpense(){const a=parseFloat(amtStr);if(!a||a<=0)return toast('Enter an amount',1);if(!selCat)return toast('Pick a category',1);const e={id:Date.now()+'',amount:a,category:selCat,description:document.getElementById('desc-input').value.trim(),date:getDate(),type:'variable',createdAt:new Date().toISOString()};S.expenses.push(e);save();syncOne(e);toast('‚úì Saved '+fmt(a));showScreen('dashboard')}

// HISTORY
let hFilter='all';
function refreshHist(){
document.getElementById('history-month-label').textContent=monthLabel();
document.getElementById('history-filters').innerHTML=[{id:'all',name:'All'},{id:'fixed',name:'Fixed'},...CATS].map(c=>`<button class="filter-tab ${hFilter===c.id?'active':''}" onclick="setHF('${c.id}')">${c.name.split(' ')[0]}</button>`).join('');
const el=document.getElementById('history-list');let items=[];
if(hFilter==='all'||hFilter==='fixed')S.fixedExpenses.forEach(e=>items.push({...e,type:'fixed',date:today().slice(0,8)+String(e.due||1).padStart(2,'0')}));
monthExps().forEach(e=>{if(hFilter==='all'||hFilter===e.category)items.push(e)});
if(hFilter==='fixed')items=items.filter(e=>e.type==='fixed');
items.sort((a,b)=>b.date.localeCompare(a.date));
if(!items.length){el.innerHTML='<div class="empty-state"><div class="emoji">üîç</div><p>No expenses found.</p></div>';return}
el.innerHTML=items.map(e=>{const c=CM[e.category]||{emoji:'üì¶',name:e.category},ds=new Date(e.date+'T00:00:00').toLocaleDateString('en-SG',{day:'numeric',month:'short'}),f=e.type==='fixed';
return`<div class="expense-item"><span class="expense-emoji">${c.emoji}</span><div class="expense-info"><div class="expense-name">${e.description||e.name||c.name}</div><div class="expense-meta">${ds} ¬∑ ${c.name}${f?' ¬∑ Fixed':''}</div></div><span class="expense-amount ${f?'fixed':''}">${fmt(e.amount)}</span>${!f?`<div class="expense-actions"><button onclick="editExp('${e.id}')">‚úèÔ∏è</button><button onclick="delExp('${e.id}')">üóëÔ∏è</button></div>`:''}</div>`}).join('')}
function setHF(id){hFilter=id;refreshHist()}

let editId=null;
function editExp(id){const e=S.expenses.find(x=>x.id===id);if(!e)return;editId=id;document.getElementById('em-amount').value=e.amount;document.getElementById('em-desc').value=e.description||'';document.getElementById('em-cat').innerHTML=CATS.map(c=>`<option value="${c.id}" ${c.id===e.category?'selected':''}>${c.emoji} ${c.name}</option>`).join('');document.getElementById('edit-modal').classList.add('show')}
function saveEdit(){const e=S.expenses.find(x=>x.id===editId);if(!e)return;e.amount=parseFloat(document.getElementById('em-amount').value)||e.amount;e.description=document.getElementById('em-desc').value.trim();e.category=document.getElementById('em-cat').value;save();closeModal('edit-modal');refreshHist();toast('‚úì Updated')}
function delExp(id){if(!confirm('Delete this expense?'))return;S.expenses=S.expenses.filter(e=>e.id!==id);save();refreshHist();toast('Deleted')}

// SETTINGS
function refreshSet(){document.getElementById('income-input').value=S.income||'';document.getElementById('sheets-url').value=S.sheetsUrl||'';updSheetStat();renderFixed()}
function saveSettings(){S.income=parseFloat(document.getElementById('income-input').value)||0;save()}
function renderFixed(){const el=document.getElementById('fixed-expenses-list');if(!S.fixedExpenses.length){el.innerHTML='<div style="padding:16px;text-align:center;color:var(--text3);font-size:13px">No fixed expenses yet.</div>';return}
el.innerHTML=S.fixedExpenses.map((e,i)=>{const c=CM[e.category]||{emoji:'üì¶',name:e.category};return`<div class="fixed-expense-item" onclick="editFix(${i})"><span style="font-size:20px">${c.emoji}</span><div class="fixed-expense-info"><div class="fixed-expense-name">${e.name}</div><div class="fixed-expense-detail">Due: ${e.due||'‚Äî'} ¬∑ ${c.name}</div></div><span class="fixed-expense-amount">${fmt(e.amount)}</span></div>`}).join('')}

let fixIdx=-1;
function showFixedModal(i){fixIdx=typeof i==='number'?i:-1;const ed=fixIdx>=0;document.getElementById('fm-title').textContent=ed?'Edit Fixed Expense':'Add Fixed Expense';document.getElementById('fm-save').textContent=ed?'Save':'Add';document.getElementById('fm-del').style.display=ed?'block':'none';document.getElementById('fm-cat').innerHTML=CATS.map(c=>`<option value="${c.id}">${c.emoji} ${c.name}</option>`).join('');if(ed){const e=S.fixedExpenses[i];document.getElementById('fm-name').value=e.name;document.getElementById('fm-amount').value=e.amount;document.getElementById('fm-cat').value=e.category;document.getElementById('fm-due').value=e.due||''}else{document.getElementById('fm-name').value='';document.getElementById('fm-amount').value='';document.getElementById('fm-due').value=''}document.getElementById('fixed-modal').classList.add('show')}
function editFix(i){showFixedModal(i)}
function saveFixed(){const n=document.getElementById('fm-name').value.trim(),a=parseFloat(document.getElementById('fm-amount').value),c=document.getElementById('fm-cat').value,d=parseInt(document.getElementById('fm-due').value)||1;if(!n)return toast('Enter a name',1);if(!a)return toast('Enter an amount',1);const e={name:n,amount:a,category:c,due:d};if(fixIdx>=0)S.fixedExpenses[fixIdx]=e;else S.fixedExpenses.push(e);save();closeModal('fixed-modal');refreshSet();toast(fixIdx>=0?'‚úì Updated':'‚úì Added')}
function deleteFixed(){if(fixIdx<0)return;if(!confirm('Delete?'))return;S.fixedExpenses.splice(fixIdx,1);save();closeModal('fixed-modal');refreshSet();toast('Deleted')}

// CSV IMPORT
let pending=[];
function handleCSV(ev){
const f=ev.target.files[0];if(!f)return;
const rd=new FileReader();rd.onload=function(e){
const lines=e.target.result.trim().split('\n');pending=[];let skip=0;
const h=lines[0].toLowerCase(),hasH=h.includes('date')||h.includes('amount');
for(let i=hasH?1:0;i<lines.length;i++){
const cols=parseCSVLine(lines[i].trim());if(cols.length<2){skip++;continue}
let ds=cols[0].trim().replace(/"/g,'');const amt=parseFloat(cols[1].replace(/[^0-9.\-]/g,''));if(!amt||isNaN(amt)){skip++;continue}
ds=parseD(ds);if(!ds){skip++;continue}
const raw=(cols[2]||'').trim().replace(/"/g,'').toLowerCase();let cid='food';
for(const c of CATS){if(raw.includes(c.id)||c.name.toLowerCase().includes(raw)||raw.includes(c.name.toLowerCase().split(' ')[0].toLowerCase())){cid=c.id;break}}
pending.push({id:Date.now()+'-'+i,amount:Math.abs(amt),category:cid,description:(cols[3]||'').trim().replace(/"/g,''),date:ds,type:'variable',createdAt:new Date().toISOString()})
}
const pv=document.getElementById('upload-preview'),ib=document.getElementById('import-btn');
if(pending.length){pv.style.display='block';ib.style.display='block';
let html=`<span style="color:var(--green);font-weight:600">‚úì ${pending.length} expenses found</span>`;
if(skip)html+=` <span style="color:var(--orange)">(${skip} skipped)</span>`;html+='<br><br>';
pending.slice(0,5).forEach(e=>{const c=CM[e.category]||{emoji:'üì¶'};html+=`<div style="padding:4px 0;border-bottom:1px solid var(--border);display:flex;justify-content:space-between"><span>${c.emoji} ${e.date}</span><span style="color:var(--red)">${fmt(e.amount)}</span></div>`});
if(pending.length>5)html+=`<div style="padding:8px 0;color:var(--text3)">...and ${pending.length-5} more</div>`;pv.innerHTML=html
}else{pv.style.display='block';ib.style.display='none';pv.innerHTML=`<span style="color:var(--red)">No valid rows found (${skip} skipped).</span><br><span style="color:var(--text3)">Expected: Date, Amount, Category, Description</span>`}
};rd.readAsText(f);ev.target.value=''}

function parseCSVLine(l){const r=[];let c='',q=false;for(let i=0;i<l.length;i++){const ch=l[i];if(ch==='"')q=!q;else if(ch===','&&!q){r.push(c);c=''}else c+=ch}r.push(c);return r}
function parseD(s){if(/^\d{4}-\d{1,2}-\d{1,2}$/.test(s)){const[y,m,d]=s.split('-');return`${y}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`}if(/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(s)){const[d,m,y]=s.split('/');return`${y}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`}if(/^\d{1,2}-\d{1,2}-\d{4}$/.test(s)){const[d,m,y]=s.split('-');return`${y}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`}return null}

function confirmImport(){if(!pending.length)return;if(!confirm('Import '+pending.length+' expenses?'))return;S.expenses.push(...pending);save();toast('‚úì '+pending.length+' imported!');pending=[];document.getElementById('upload-preview').style.display='none';document.getElementById('import-btn').style.display='none';if(S.sheetsUrl)syncAll()}

// SHEETS
function saveSheetsUrl(){S.sheetsUrl=document.getElementById('sheets-url').value.trim();save();updSheetStat()}
function updSheetStat(){const el=document.getElementById('sheets-status');el.textContent=S.sheetsUrl?'üü¢ Connected':'‚ö™ Not connected';el.className='sheets-status '+(S.sheetsUrl?'connected':'disconnected')}
async function post(p){if(!S.sheetsUrl)return;try{await fetch(S.sheetsUrl,{method:'POST',mode:'no-cors',headers:{'Content-Type':'text/plain'},body:JSON.stringify(p)});return true}catch(e){return false}}
function syncOne(e){const c=CM[e.category]||{name:e.category};post({action:'addExpense',date:e.date,amount:e.amount,category:c.name,description:e.description||'',type:e.type||'variable'})}
async function testSheets(){if(!S.sheetsUrl)return toast('Enter URL first',1);toast('Testing...');await post({action:'test'});toast('Request sent! Check your sheet.')}
async function syncAll(){if(!S.sheetsUrl)return toast('Enter URL first',1);toast('Syncing...');for(const e of S.fixedExpenses){const c=CM[e.category]||{name:e.category};await post({action:'addExpense',date:today(),amount:e.amount,category:c.name,description:e.name+' (Fixed)',type:'fixed'})}for(const e of S.expenses){const c=CM[e.category]||{name:e.category};await post({action:'addExpense',date:e.date,amount:e.amount,category:c.name,description:e.description||'',type:'variable'})}toast('‚úì All synced!')}

// EXPORT
function exportCSV(){let csv='Date,Amount,Category,Description,Type\n';S.fixedExpenses.forEach(e=>{const c=CM[e.category]||{name:e.category};csv+=`${today()},${e.amount},"${c.name}","${e.name}",fixed\n`});S.expenses.forEach(e=>{const c=CM[e.category]||{name:e.category};csv+=`${e.date},${e.amount},"${c.name}","${e.description||''}",variable\n`});const b=new Blob([csv],{type:'text/csv'}),u=URL.createObjectURL(b),a=document.createElement('a');a.href=u;a.download='spendwise-'+today()+'.csv';a.click();URL.revokeObjectURL(u);toast('‚úì Exported')}
function clearData(){if(!confirm('Delete ALL data?'))return;if(!confirm('Really?'))return;localStorage.removeItem('sw');S={income:0,fixedExpenses:[],expenses:[],sheetsUrl:''};refreshSet();toast('Cleared')}

// INIT
load();refreshDash();renderCatGrid();
document.querySelectorAll('.modal-overlay').forEach(m=>{m.addEventListener('click',e=>{if(e.target===m)m.classList.remove('show')})});
window.addEventListener('resize',()=>{if(curScreen==='dashboard')drawTrend()});
</script>
</body>
</html>
