<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="SpendWise">
<meta name="theme-color" content="#08080d">
<meta name="format-detection" content="telephone=no">
<title>SpendWise</title>
<link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiU3BlbmRXaXNlIiwic2hvcnRfbmFtZSI6IlNwZW5kV2lzZSIsInN0YXJ0X3VybCI6Ii4iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjMDgwODBkIiwidGhlbWVfY29sb3IiOiIjMDgwODBkIn0=">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none}

:root{
  --bg:#08080d;
  --surface:rgba(255,255,255,0.04);
  --surface2:rgba(255,255,255,0.07);
  --surface3:rgba(255,255,255,0.10);
  --border:rgba(255,255,255,0.08);
  --border2:rgba(255,255,255,0.12);
  --text:#f0f0f5;
  --text2:#9090ad;
  --text3:#5c5c78;
  --accent:#7c6df0;
  --accent2:#b4a9ff;
  --accent-glow:rgba(124,109,240,0.15);
  --green:#34d399;
  --green-soft:rgba(52,211,153,0.12);
  --red:#f87171;
  --red-soft:rgba(248,113,113,0.12);
  --orange:#fbbf24;
  --orange-soft:rgba(251,191,36,0.12);
  --r:14px;
  --r-sm:10px;
  --safe-t:env(safe-area-inset-top,20px);
  --safe-b:env(safe-area-inset-bottom,0px);
  --nav-h:72px;
}

html,body{
  font-family:'Outfit',-apple-system,BlinkMacSystemFont,sans-serif;
  background:var(--bg);color:var(--text);
  height:100%;height:100dvh;
  overflow:hidden;overscroll-behavior:none;
  font-size:16px;line-height:1.4;
  -webkit-font-smoothing:antialiased;
}
body{position:fixed;width:100%;touch-action:pan-y}

/* === SCREENS === */
.screen{position:absolute;inset:0;display:none;flex-direction:column;overflow:hidden}
.screen.active{display:flex}

/* === HEADER === */
.header{
  padding:calc(var(--safe-t)+6px) 20px 10px;
  background:var(--bg);z-index:10;
  flex-shrink:0;
}
.header h1{
  font-family:'JetBrains Mono',monospace;
  font-size:clamp(20px,5vw,24px);
  font-weight:700;letter-spacing:-0.5px;
}
.header-sub{color:var(--text2);font-size:13px;margin-top:1px;font-weight:400}

/* === SCROLL === */
.scroll-area{
  flex:1;overflow-y:auto;overflow-x:hidden;
  -webkit-overflow-scrolling:touch;
  padding:0 16px calc(var(--nav-h) + var(--safe-b) + 20px);
  scrollbar-width:none;
}
.scroll-area::-webkit-scrollbar{display:none}

/* === BUDGET CARD === */
.budget-card{
  background:linear-gradient(145deg,rgba(124,109,240,0.08) 0%,rgba(52,211,153,0.04) 100%);
  border:1px solid var(--border2);
  border-radius:var(--r);
  padding:clamp(16px,4vw,22px);
  margin:10px 0 14px;
  position:relative;overflow:hidden;
}
.budget-card::before{
  content:'';position:absolute;top:-60%;right:-20%;
  width:clamp(160px,50vw,240px);height:clamp(160px,50vw,240px);
  background:radial-gradient(circle,var(--accent-glow),transparent 70%);
  pointer-events:none;
}
.budget-label{font-size:11px;color:var(--text3);text-transform:uppercase;letter-spacing:1.5px;font-weight:600}
.budget-amount{
  font-family:'JetBrains Mono',monospace;
  font-size:clamp(28px,8vw,38px);
  font-weight:700;margin:4px 0 14px;letter-spacing:-1px;
}
.budget-amount.positive{color:var(--text)}.budget-amount.negative{color:var(--red)}.budget-amount.warning{color:var(--orange)}
.budget-bar-track{height:5px;background:var(--surface3);border-radius:3px;overflow:hidden;margin-bottom:14px}
.budget-bar-fill{height:100%;border-radius:3px;transition:width .5s cubic-bezier(.4,0,.2,1),background .3s}
.budget-row{display:flex;justify-content:space-between;align-items:center;padding:5px 0}
.budget-row-label{font-size:13px;color:var(--text2);font-weight:400}
.budget-row-value{font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:600}

/* === QUICK STATS === */
.quick-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:14px}
.stat-card{
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--r-sm);padding:clamp(10px,3vw,14px);
  min-height:0;
}
.stat-icon{font-size:16px;margin-bottom:3px}
.stat-label{font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:.8px;font-weight:600}
.stat-value{font-family:'JetBrains Mono',monospace;font-size:clamp(14px,3.5vw,17px);font-weight:700;margin-top:2px}

.section-title{font-size:11px;color:var(--text3);text-transform:uppercase;letter-spacing:1.5px;margin:18px 0 8px;font-weight:600}

/* === MONTH COMPARISON === */
.mom-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:14px;margin-bottom:12px}
.mom-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.mom-header-left{display:flex;flex-direction:column;gap:2px}
.mom-total{font-family:'JetBrains Mono',monospace;font-size:clamp(20px,5vw,26px);font-weight:700}
.mom-label{font-size:11px;color:var(--text3);font-weight:500}
.mom-badge{
  display:inline-flex;align-items:center;gap:3px;
  padding:5px 10px;border-radius:20px;
  font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:700;
  flex-shrink:0;
}
.mom-badge.up{background:var(--red-soft);color:var(--red)}
.mom-badge.down{background:var(--green-soft);color:var(--green)}
.mom-badge.flat{background:var(--surface2);color:var(--text3)}
.mom-row{
  display:flex;align-items:center;gap:8px;
  padding:8px 0;border-bottom:1px solid var(--border);
}
.mom-row:last-child{border-bottom:none}
.mom-row-emoji{font-size:18px;width:26px;text-align:center;flex-shrink:0}
.mom-row-info{flex:1;min-width:0}
.mom-row-name{font-size:12px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.mom-row-bar{display:flex;gap:3px;margin-top:4px;height:6px;border-radius:3px;overflow:hidden;background:var(--surface3)}
.mom-bar-cur{height:100%;border-radius:3px 0 0 3px;transition:width .4s cubic-bezier(.4,0,.2,1)}
.mom-bar-prev{height:100%;border-radius:0 3px 3px 0;opacity:0.3;transition:width .4s cubic-bezier(.4,0,.2,1)}
.mom-row-amounts{display:flex;flex-direction:column;align-items:flex-end;flex-shrink:0;gap:1px}
.mom-row-cur{font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:700}
.mom-row-prev{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text3)}
.mom-row-pct{
  font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:700;
  padding:2px 6px;border-radius:10px;margin-left:4px;white-space:nowrap;
}
.mom-row-pct.up{color:var(--red);background:var(--red-soft)}
.mom-row-pct.down{color:var(--green);background:var(--green-soft)}
.mom-row-pct.new{color:var(--accent2);background:var(--accent-glow)}
.mom-no-data{text-align:center;padding:16px;color:var(--text3);font-size:13px}

/* === CHARTS === */
.chart-container{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:14px;margin-bottom:12px}
.chart-toggle{display:flex;gap:4px;margin-bottom:10px}
.chart-toggle button{
  flex:1;padding:8px;border-radius:8px;font-size:12px;font-weight:600;
  border:1px solid var(--border);background:transparent;color:var(--text3);
  cursor:pointer;font-family:'Outfit',sans-serif;
  transition:all .15s;min-height:36px;
}
.chart-toggle button.active{background:var(--accent);border-color:var(--accent);color:#fff}

/* === CATEGORY BARS === */
.cat-row{display:flex;align-items:center;padding:10px 0;gap:10px}
.cat-emoji{font-size:20px;width:28px;text-align:center;flex-shrink:0}
.cat-info{flex:1;min-width:0}
.cat-name{font-size:13px;font-weight:500}
.cat-bar-track{height:4px;background:var(--surface3);border-radius:2px;margin-top:4px}
.cat-bar-fill{height:100%;border-radius:2px;transition:width .4s cubic-bezier(.4,0,.2,1)}
.cat-amount{font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--text2);white-space:nowrap;flex-shrink:0}

/* === EXPENSE LIST === */
.expense-item{
  display:flex;align-items:center;
  padding:12px 0;gap:10px;
  border-bottom:1px solid var(--border);
}
.expense-item:last-child{border-bottom:none}
.expense-emoji{font-size:22px;width:34px;text-align:center;flex-shrink:0}
.expense-info{flex:1;min-width:0}
.expense-name{font-size:14px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.expense-meta{font-size:11px;color:var(--text3);margin-top:2px}
.expense-amount{font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:700;color:var(--red);white-space:nowrap;flex-shrink:0}
.expense-amount.fixed{color:var(--text2)}
/* Touch-friendly action buttons: min 44x44 */
.expense-actions{display:flex;gap:6px;flex-shrink:0}
.expense-actions button{
  background:var(--surface2);border:none;color:var(--text2);
  width:44px;height:44px;border-radius:var(--r-sm);
  font-size:16px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  transition:background .15s;
}
.expense-actions button:active{background:var(--surface3)}

/* === FILTER TABS === */
.filter-tabs{
  display:flex;gap:6px;margin:10px 16px;
  overflow-x:auto;padding-bottom:4px;
  -webkit-overflow-scrolling:touch;flex-shrink:0;
}
.filter-tabs::-webkit-scrollbar{display:none}
.filter-tab{
  flex-shrink:0;padding:8px 16px;border-radius:20px;
  font-size:12px;font-weight:600;
  border:1px solid var(--border);background:transparent;color:var(--text2);
  cursor:pointer;transition:all .15s;
  min-height:36px;display:flex;align-items:center;
}
.filter-tab.active{background:var(--accent);border-color:var(--accent);color:white}

/* === ADD EXPENSE === */
.amount-display{text-align:center;padding:clamp(16px,5vw,28px) 20px clamp(12px,3vw,18px)}
.amount-currency{font-size:18px;color:var(--text3);font-weight:500}
.amount-value{
  font-family:'JetBrains Mono',monospace;
  font-size:clamp(38px,12vw,54px);
  font-weight:700;letter-spacing:-2px;
  min-height:50px;
}
.amount-value.empty{color:var(--text3)}

/* Category grid: 4 cols on wider phones, 3 on narrow */
.category-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(85px,1fr));
  gap:7px;padding:0 16px;margin-bottom:12px;
}
.cat-btn{
  display:flex;flex-direction:column;align-items:center;
  gap:3px;padding:10px 4px;
  background:var(--surface);border:2px solid var(--border);
  border-radius:var(--r-sm);color:var(--text2);
  font-size:10px;font-weight:600;cursor:pointer;
  transition:all .12s;min-height:60px;
  justify-content:center;
}
.cat-btn .emoji{font-size:20px}
.cat-btn.selected{border-color:var(--accent);background:var(--accent-glow);color:var(--text)}

.desc-input{
  margin:0 16px 8px;padding:14px 16px;
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--r-sm);color:var(--text);
  font-family:'Outfit',sans-serif;font-size:16px;
  width:calc(100% - 32px);outline:none;
  -webkit-appearance:none;appearance:none;
}
.desc-input::placeholder{color:var(--text3)}.desc-input:focus{border-color:var(--accent)}

.date-row{display:flex;gap:6px;padding:0 16px;margin-bottom:8px}
.date-btn{
  flex:1;padding:10px 6px;
  background:var(--surface);border:2px solid var(--border);
  border-radius:var(--r-sm);color:var(--text2);
  font-size:12px;font-weight:600;cursor:pointer;
  text-align:center;min-height:44px;
  display:flex;align-items:center;justify-content:center;
}
.date-btn.selected{border-color:var(--accent);color:var(--text);background:var(--accent-glow)}

/* Numpad: responsive sizing */
.numpad{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;padding:4px 16px}
.num-key{
  height:clamp(48px,12vw,56px);
  background:var(--surface);border:none;
  border-radius:var(--r-sm);color:var(--text);
  font-family:'JetBrains Mono',monospace;
  font-size:clamp(20px,5vw,24px);font-weight:700;
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  transition:background .08s;
  -webkit-user-select:none;user-select:none;
}
.num-key:active{background:var(--surface3);transform:scale(0.97)}
.num-key.del{font-size:18px}

/* === SETTINGS === */
.settings-group{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);margin-bottom:12px;overflow:hidden}
.settings-row{
  display:flex;justify-content:space-between;align-items:center;
  padding:16px;border-bottom:1px solid var(--border);
  min-height:52px;
}
.settings-row:last-child{border-bottom:none}
.settings-label{font-size:14px;font-weight:500}
.settings-input{
  background:transparent;border:none;color:var(--accent2);
  font-family:'JetBrains Mono',monospace;font-size:16px;
  text-align:right;width:140px;outline:none;
  -webkit-appearance:none;
}
.fixed-expense-item{
  display:flex;align-items:center;padding:14px 16px;
  border-bottom:1px solid var(--border);gap:10px;
  cursor:pointer;min-height:56px;
}
.fixed-expense-item:last-child{border-bottom:none}
.fixed-expense-item:active{background:var(--surface2)}
.fixed-expense-info{flex:1;min-width:0}
.fixed-expense-name{font-size:14px;font-weight:500}
.fixed-expense-detail{font-size:12px;color:var(--text3)}
.fixed-expense-amount{font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:700;flex-shrink:0}

.btn-add-fixed{
  display:flex;align-items:center;justify-content:center;gap:6px;
  padding:14px;background:transparent;
  border:2px dashed var(--border);border-radius:var(--r-sm);
  color:var(--text3);font-family:'Outfit',sans-serif;font-size:14px;font-weight:500;
  cursor:pointer;width:100%;margin-bottom:12px;min-height:52px;
}
.sheets-url-input{
  width:100%;padding:14px;
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--r-sm);color:var(--text);
  font-family:'Outfit',sans-serif;font-size:14px;
  outline:none;margin-bottom:8px;-webkit-appearance:none;
}
.sheets-url-input:focus{border-color:var(--accent)}
.sheets-status{font-size:12px;padding:6px 0;font-weight:500}
.sheets-status.connected{color:var(--green)}.sheets-status.disconnected{color:var(--text3)}

.btn-primary{
  width:100%;padding:16px;
  background:var(--accent);border:none;
  border-radius:var(--r-sm);color:white;
  font-family:'Outfit',sans-serif;font-size:15px;font-weight:600;
  cursor:pointer;margin-top:8px;min-height:52px;
  transition:transform .1s,opacity .1s;
}
.btn-primary:active{transform:scale(0.98);opacity:0.9}
.btn-danger{background:transparent;border:1px solid var(--red);color:var(--red)}

.upload-zone{
  border:2px dashed var(--border);border-radius:var(--r);
  padding:28px 16px;text-align:center;cursor:pointer;
  margin-bottom:12px;min-height:100px;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  transition:border-color .15s;
}
.upload-zone:active{border-color:var(--accent)}
.upload-zone .big-emoji{font-size:30px;margin-bottom:8px}
.upload-zone p{font-size:13px;color:var(--text3);line-height:1.5}
.upload-zone .hl{color:var(--accent2);font-weight:600}
.upload-preview{
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--r-sm);padding:12px 16px;margin-bottom:10px;
  font-size:13px;max-height:200px;overflow-y:auto;display:none;
}

/* === MODAL === */
.modal-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.65);
  z-index:100;display:none;align-items:flex-end;justify-content:center;
  backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px);
}
.modal-overlay.show{display:flex}
.modal{
  background:#12121c;
  border-radius:var(--r) var(--r) 0 0;
  width:100%;max-width:430px;
  padding:24px 20px calc(var(--safe-b)+24px);
  max-height:85vh;overflow-y:auto;
}
.modal h3{font-size:18px;font-weight:600;margin-bottom:16px}
.modal-input{
  width:100%;padding:14px;
  background:var(--surface2);border:1px solid var(--border);
  border-radius:var(--r-sm);color:var(--text);
  font-family:'Outfit',sans-serif;font-size:16px;
  outline:none;margin-bottom:10px;-webkit-appearance:none;
}
.modal-input:focus{border-color:var(--accent)}
.modal-row{display:flex;gap:10px}

/* === NAV BAR === */
.nav-bar{
  position:fixed;bottom:0;left:0;right:0;
  background:rgba(8,8,13,0.88);
  backdrop-filter:saturate(180%) blur(20px);
  -webkit-backdrop-filter:saturate(180%) blur(20px);
  border-top:1px solid var(--border);
  display:flex;
  padding:4px 0 calc(var(--safe-b)+4px);
  z-index:50;height:auto;
}
.nav-item{
  flex:1;display:flex;flex-direction:column;align-items:center;
  gap:1px;padding:8px 0;background:none;border:none;
  color:var(--text3);font-size:10px;font-weight:500;
  cursor:pointer;min-height:48px;justify-content:center;
  transition:color .15s;
}
.nav-item.active{color:var(--accent2)}
.nav-icon{font-size:22px;height:24px;display:flex;align-items:center}
.nav-item.add-btn .nav-icon{
  width:48px;height:48px;
  background:var(--accent);border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-size:28px;color:white;margin-top:-20px;
  box-shadow:0 4px 24px rgba(124,109,240,0.35);
}

/* === TOAST === */
.toast{
  position:fixed;top:calc(var(--safe-t)+8px);left:50%;
  transform:translateX(-50%) translateY(-100px);
  background:var(--green);color:#08080d;
  padding:10px 20px;border-radius:20px;
  font-size:13px;font-weight:600;
  z-index:200;transition:transform .3s cubic-bezier(.4,0,.2,1);
  white-space:nowrap;max-width:calc(100% - 40px);
  text-align:center;
}
.toast.show{transform:translateX(-50%) translateY(0)}
.toast.error{background:var(--red);color:white}

.empty-state{text-align:center;padding:32px 20px;color:var(--text3)}
.empty-state .emoji{font-size:40px;margin-bottom:10px}
.empty-state p{font-size:14px;line-height:1.5}

/* Donut */
.donut-wrapper{position:relative;display:flex;justify-content:center}
.donut-center{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;pointer-events:none}
.donut-center .val{font-family:'JetBrains Mono',monospace;font-size:18px;font-weight:700}
.donut-center .lbl{font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:.8px;font-weight:600}
.chart-legend{display:flex;flex-wrap:wrap;gap:5px 12px;margin-top:10px}
.legend-item{display:flex;align-items:center;gap:4px;font-size:11px;color:var(--text2)}
.legend-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}

/* Subtle entry animation */
@keyframes slideUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
.animate-in{animation:slideUp .35s cubic-bezier(.4,0,.2,1) forwards}

/* Focus visible for accessibility */
:focus-visible{outline:2px solid var(--accent);outline-offset:2px}

/* Prevent iOS zoom on input focus */
@supports (-webkit-touch-callout: none){
  input[type="text"],input[type="number"],input[type="url"],input[type="date"],select,textarea{font-size:16px!important}
}
</style>
</head>
<body>
<div class="toast" id="toast"></div>

<!-- DASHBOARD -->
<div class="screen active" id="screen-dashboard">
<div class="header"><h1>SpendWise</h1><div class="header-sub" id="month-label"></div></div>
<div class="scroll-area">
<div class="budget-card animate-in">
<div class="budget-label">Total Spent This Month</div>
<div class="budget-amount" id="total-spent-amount">S$0.00</div>
<div class="budget-bar-track"><div class="budget-bar-fill" id="budget-bar"></div></div>
<div class="budget-row"><span class="budget-row-label">Income</span><span class="budget-row-value" id="income-display" style="color:var(--green)">S$0.00</span></div>
<div class="budget-row"><span class="budget-row-label">Fixed Expenses</span><span class="budget-row-value" id="fixed-display" style="color:var(--text2)">S$0.00</span></div>
<div class="budget-row"><span class="budget-row-label">Variable Spent</span><span class="budget-row-value" id="variable-display" style="color:var(--red)">S$0.00</span></div>
<div class="budget-row"><span class="budget-row-label">Remaining Budget</span><span class="budget-row-value" id="remaining-display" style="color:var(--green)">S$0.00</span></div>
</div>
<div class="quick-stats">
<div class="stat-card"><div class="stat-icon">üìÖ</div><div class="stat-label">Today</div><div class="stat-value" id="today-spent">S$0</div></div>
<div class="stat-card"><div class="stat-icon">üìä</div><div class="stat-label">Avg/Day</div><div class="stat-value" id="daily-avg">S$0</div></div>
<div class="stat-card"><div class="stat-icon">üî¢</div><div class="stat-label">Txns</div><div class="stat-value" id="txn-count">0</div></div>
</div>
<div class="section-title">vs Last Month</div>
<div id="mom-comparison"></div>
<div class="section-title">Spending Trend</div>
<div class="chart-container">
<div class="chart-toggle" id="trend-toggle"><button class="active" onclick="setTrendView('weekly',this)">Weekly</button><button onclick="setTrendView('monthly',this)">Monthly</button></div>
<canvas id="trend-chart" height="180"></canvas>
</div>
<div class="section-title">Category Breakdown</div>
<div class="chart-container">
<div class="donut-wrapper"><canvas id="donut-chart" width="200" height="200" style="max-width:200px;max-height:200px"></canvas>
<div class="donut-center"><div class="val" id="donut-total">S$0</div><div class="lbl">Variable</div></div></div>
<div class="chart-legend" id="donut-legend"></div>
</div>
<div class="section-title">By Category</div>
<div id="category-breakdown"></div>
</div></div>

<!-- ADD -->
<div class="screen" id="screen-add">
<div class="header"><h1>Add Expense</h1></div>
<div class="scroll-area" style="padding-bottom:20px">
<div class="amount-display"><span class="amount-currency">S$</span><div class="amount-value empty" id="amount-display">0.00</div></div>
<div class="category-grid" id="category-grid"></div>
<input type="text" class="desc-input" id="desc-input" placeholder="Description (optional)" maxlength="50" enterkeyhint="done" autocomplete="off">
<div class="date-row"><button class="date-btn selected" id="date-today" onclick="selectDate('today')">Today</button><button class="date-btn" id="date-yesterday" onclick="selectDate('yesterday')">Yesterday</button><button class="date-btn" id="date-custom" onclick="selectDate('custom')">Pick</button></div>
<input type="date" id="custom-date" style="display:none;margin:0 16px 8px;width:calc(100% - 32px)" class="desc-input">
<div class="numpad">
<button class="num-key" onclick="numInput('1')">1</button><button class="num-key" onclick="numInput('2')">2</button><button class="num-key" onclick="numInput('3')">3</button>
<button class="num-key" onclick="numInput('4')">4</button><button class="num-key" onclick="numInput('5')">5</button><button class="num-key" onclick="numInput('6')">6</button>
<button class="num-key" onclick="numInput('7')">7</button><button class="num-key" onclick="numInput('8')">8</button><button class="num-key" onclick="numInput('9')">9</button>
<button class="num-key" onclick="numInput('.')">.</button><button class="num-key" onclick="numInput('0')">0</button><button class="num-key del" onclick="numDelete()">‚å´</button>
</div>
<div style="padding:6px 16px"><button class="btn-primary" onclick="saveExpense()">Save Expense</button></div>
</div></div>

<!-- HISTORY -->
<div class="screen" id="screen-history">
<div class="header"><h1>History</h1><div class="header-sub" id="history-month-label"></div></div>
<div class="filter-tabs" id="history-filters"></div>
<div class="scroll-area" style="padding-top:6px" id="history-list"></div>
</div>

<!-- SETTINGS -->
<div class="screen" id="screen-settings">
<div class="header"><h1>Settings</h1></div>
<div class="scroll-area" style="padding-top:10px">
<div class="section-title">Monthly Income</div>
<div class="settings-group"><div class="settings-row"><span class="settings-label">Income</span><input type="tel" inputmode="decimal" class="settings-input" id="income-input" placeholder="0.00" onchange="saveSettings()"></div></div>
<div class="section-title">Fixed Monthly Expenses</div>
<div class="settings-group" id="fixed-expenses-list"></div>
<button class="btn-add-fixed" onclick="showFixedModal()">+ Add Fixed Expense</button>
<div class="section-title">Import Past Expenses</div>
<div class="upload-zone" onclick="document.getElementById('csv-file').click()">
<span class="big-emoji">üìé</span>
<p>Tap to upload a <span class="hl">CSV file</span></p>
<p style="font-size:11px;margin-top:6px;color:var(--text3)">Format: Date, Amount, Category, Description<br>Date as YYYY-MM-DD or DD/MM/YY</p>
</div>
<input type="file" id="csv-file" accept=".csv,.txt" style="display:none" onchange="handleCSV(event)">
<div class="upload-preview" id="upload-preview"></div>
<button class="btn-primary" id="import-btn" style="display:none;margin-bottom:12px" onclick="confirmImport()">Import Expenses</button>
<div class="section-title">Google Sheets Sync</div>
<div class="settings-group" style="padding:14px 16px">
<p style="font-size:12px;color:var(--text3);margin-bottom:10px">Paste your Google Apps Script Web App URL.</p>
<input type="url" class="sheets-url-input" id="sheets-url" placeholder="https://script.google.com/macros/s/..." onchange="saveSheetsUrl()">
<div class="sheets-status disconnected" id="sheets-status">Not connected</div>
<button class="btn-primary" onclick="testSheets()" style="margin-top:4px">Test Connection</button>
<button class="btn-primary" onclick="syncAll()" style="margin-top:8px;background:var(--green);color:#08080d">Sync All Data</button>
</div>
<div class="section-title">Data</div>
<div class="settings-group"><div class="settings-row" style="cursor:pointer" onclick="exportCSV()"><span class="settings-label">üì• Export as CSV</span><span style="color:var(--accent2)">‚Üí</span></div></div>
<button class="btn-primary btn-danger" onclick="clearData()" style="margin-bottom:40px">Clear All Data</button>
</div></div>

<!-- NAV -->
<nav class="nav-bar">
<button class="nav-item active" onclick="showScreen('dashboard')"><span class="nav-icon">üìä</span>Dashboard</button>
<button class="nav-item" onclick="showScreen('history')"><span class="nav-icon">üìã</span>History</button>
<button class="nav-item add-btn" onclick="showScreen('add')"><span class="nav-icon">+</span></button>
<button class="nav-item" onclick="showScreen('settings')"><span class="nav-icon">‚öôÔ∏è</span>Settings</button>
</nav>

<!-- MODALS -->
<div class="modal-overlay" id="fixed-modal"><div class="modal">
<h3 id="fm-title">Add Fixed Expense</h3>
<input type="text" class="modal-input" id="fm-name" placeholder="Name (e.g., Rent)" autocomplete="off">
<input type="tel" inputmode="decimal" class="modal-input" id="fm-amount" placeholder="Amount (S$)">
<select class="modal-input" id="fm-cat"></select>
<input type="tel" inputmode="numeric" class="modal-input" id="fm-due" placeholder="Due date (1-31)">
<div class="modal-row"><button class="btn-primary" onclick="saveFixed()" id="fm-save">Add</button><button class="btn-primary btn-danger" onclick="closeModal('fixed-modal')" style="flex:.5">Cancel</button></div>
<button class="btn-primary btn-danger" id="fm-del" style="display:none;margin-top:8px" onclick="deleteFixed()">Delete</button>
</div></div>

<div class="modal-overlay" id="edit-modal"><div class="modal">
<h3>Edit Expense</h3>
<input type="tel" inputmode="decimal" class="modal-input" id="em-amount" placeholder="Amount (S$)">
<input type="text" class="modal-input" id="em-desc" placeholder="Description" autocomplete="off">
<select class="modal-input" id="em-cat"></select>
<div class="modal-row"><button class="btn-primary" onclick="saveEdit()">Save</button><button class="btn-primary btn-danger" onclick="closeModal('edit-modal')" style="flex:.5">Cancel</button></div>
</div></div>

<script>
var CATS=[
{id:'food',name:'Food & Dining',emoji:'üçú',color:'#f87171'},
{id:'transport',name:'Transport',emoji:'üöå',color:'#fbbf24'},
{id:'groceries',name:'Groceries',emoji:'üõí',color:'#34d399'},
{id:'entertainment',name:'Entertainment',emoji:'üéÆ',color:'#a78bfa'},
{id:'shopping',name:'Shopping',emoji:'üõçÔ∏è',color:'#f472b6'},
{id:'coffee',name:'Coffee/Drinks',emoji:'‚òï',color:'#fb923c'},
{id:'health',name:'Health',emoji:'üíä',color:'#22d3ee'},
{id:'utilities',name:'Utilities/Bills',emoji:'üí°',color:'#818cf8'},
{id:'memberships',name:'Memberships',emoji:'üèãÔ∏è',color:'#fcd34d'},
{id:'taxi',name:'Taxi/Ride',emoji:'üöï',color:'#60a5fa'},
{id:'alcohol',name:'Alcohol',emoji:'üç∫',color:'#e879f9'}
];
var CM={};CATS.forEach(function(c){CM[c.id]=c});

var S={income:0,fixedExpenses:[],expenses:[],sheetsUrl:''};
function load(){try{var s=localStorage.getItem('sw');if(s)S=Object.assign({},S,JSON.parse(s))}catch(e){}}
function save(){localStorage.setItem('sw',JSON.stringify(S))}
function fmt(n){return'S$'+Number(n).toFixed(2)}
function today(){return new Date().toISOString().split('T')[0]}
function monthLabel(){return new Date().toLocaleDateString('en-SG',{month:'long',year:'numeric'})}
function monthExps(){var now=new Date(),ym=now.getFullYear()+'-'+String(now.getMonth()+1).padStart(2,'0');return S.expenses.filter(function(e){return e.date&&e.date.startsWith(ym)})}

var curScreen='dashboard';
function showScreen(n){curScreen=n;document.querySelectorAll('.screen').forEach(function(s){s.classList.remove('active')});document.getElementById('screen-'+n).classList.add('active');document.querySelectorAll('.nav-item').forEach(function(x){x.classList.remove('active')});var m={dashboard:0,history:1,add:2,settings:3};if(m[n]!==undefined)document.querySelectorAll('.nav-item')[m[n]].classList.add('active');if(n==='dashboard')refreshDash();if(n==='history')refreshHist();if(n==='settings')refreshSet();if(n==='add')resetAdd()}
function toast(msg,err){var t=document.getElementById('toast');t.textContent=msg;t.className='toast'+(err?' error':'');setTimeout(function(){t.classList.add('show')},10);setTimeout(function(){t.classList.remove('show')},2500)}
function closeModal(id){document.getElementById(id).classList.remove('show')}

var trendView='weekly';
function setTrendView(v,btn){trendView=v;document.querySelectorAll('#trend-toggle button').forEach(function(b){b.classList.remove('active')});btn.classList.add('active');drawTrend()}

function refreshDash(){
document.getElementById('month-label').textContent=monthLabel();
var inc=S.income||0,fixT=S.fixedExpenses.reduce(function(s,e){return s+Number(e.amount)},0);
var me=monthExps(),varT=me.reduce(function(s,e){return s+Number(e.amount)},0);
var totalSpent=fixT+varT,rem=inc-totalSpent;
var el=document.getElementById('total-spent-amount');el.textContent=fmt(totalSpent);
el.className='budget-amount '+(totalSpent>inc*.9?'negative':totalSpent>inc*.7?'warning':'positive');
document.getElementById('income-display').textContent=fmt(inc);
document.getElementById('fixed-display').textContent=fmt(fixT);
document.getElementById('variable-display').textContent=fmt(varT);
var remEl=document.getElementById('remaining-display');remEl.textContent=fmt(rem);
remEl.style.color=rem>inc*.3?'var(--green)':rem>0?'var(--orange)':'var(--red)';
var pct=inc>0?Math.min(totalSpent/inc*100,100):0;
var bar=document.getElementById('budget-bar');bar.style.width=pct+'%';bar.style.background=pct>90?'var(--red)':pct>70?'var(--orange)':'var(--green)';
var td=today(),todT=me.filter(function(e){return e.date===td}).reduce(function(s,e){return s+Number(e.amount)},0);
document.getElementById('today-spent').textContent=fmt(todT);
var dom=new Date().getDate();
document.getElementById('daily-avg').textContent=fmt(dom>0?varT/dom:0);
document.getElementById('txn-count').textContent=me.length;
drawTrend();drawDonut(me);drawCatBars(me);drawComparison(me,varT);
}

function drawTrend(){
var c=document.getElementById('trend-chart');var parent=c.parentElement;
var W=parent.clientWidth-28;if(W<100)W=300;var H=180;
var dpr=window.devicePixelRatio||1;
c.style.width=W+'px';c.style.height=H+'px';c.width=W*dpr;c.height=H*dpr;
var ctx=c.getContext('2d');ctx.scale(dpr,dpr);ctx.clearRect(0,0,W,H);
var labels=[],vals=[];
if(trendView==='weekly'){
var now=new Date(),yr=now.getFullYear(),mo=now.getMonth(),dim=new Date(yr,mo+1,0).getDate();
var ym=yr+'-'+String(mo+1).padStart(2,'0');
var me=S.expenses.filter(function(e){return e.date&&e.date.startsWith(ym)});
for(var w=0;w<Math.ceil(dim/7);w++){var ws=w*7+1,we=Math.min(ws+6,dim);labels.push('W'+(w+1));var t=0;me.forEach(function(e){var d=parseInt(e.date.split('-')[2]);if(d>=ws&&d<=we)t+=Number(e.amount)});vals.push(t)}
}else{
var monthMap={};S.expenses.forEach(function(e){if(!e.date)return;var ym=e.date.substring(0,7);monthMap[ym]=(monthMap[ym]||0)+Number(e.amount)});
var now=new Date(),recent=[];
for(var i=5;i>=0;i--){var d=new Date(now.getFullYear(),now.getMonth()-i,1);recent.push(d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0'))}
var shown=recent.slice();Object.keys(monthMap).forEach(function(ym){if(shown.indexOf(ym)<0)shown.push(ym)});
shown.sort();shown=shown.slice(-6);
shown.forEach(function(ym){var parts=ym.split('-');var d=new Date(parseInt(parts[0]),parseInt(parts[1])-1,1);labels.push(d.toLocaleDateString('en-SG',{month:'short'}));vals.push(monthMap[ym]||0)});
}
if(vals.every(function(v){return v===0})){ctx.fillStyle='#5c5c78';ctx.font='500 13px Outfit';ctx.textAlign='center';ctx.fillText('No data yet',W/2,H/2);return}
var mx=Math.max.apply(null,vals.concat([1]));
var pL=8,pR=8,pT=26,pB=30,cW=W-pL-pR,cH=H-pT-pB;
var bW=Math.min(cW/labels.length*0.55,42),gap=cW/labels.length;
ctx.strokeStyle='rgba(255,255,255,0.04)';ctx.lineWidth=1;
for(var i=0;i<=3;i++){var gy=pT+cH*(1-i/3);ctx.beginPath();ctx.moveTo(pL,gy);ctx.lineTo(W-pR,gy);ctx.stroke()}
for(var i=0;i<vals.length;i++){var v=vals[i],x=pL+gap*i+gap/2-bW/2,bH=mx>0?(v/mx)*cH:0,y=pT+cH-bH;
var g=ctx.createLinearGradient(x,y,x,pT+cH);g.addColorStop(0,'#7c6df0');g.addColorStop(1,'#5b4cc4');ctx.fillStyle=g;
var rad=Math.min(bW/2,5);ctx.beginPath();ctx.moveTo(x,pT+cH);ctx.lineTo(x,y+rad);ctx.arcTo(x,y,x+rad,y,rad);ctx.arcTo(x+bW,y,x+bW,y+rad,rad);ctx.lineTo(x+bW,pT+cH);ctx.closePath();ctx.fill();
if(v>0){ctx.fillStyle='#b4a9ff';ctx.font='600 9px JetBrains Mono';ctx.textAlign='center';ctx.fillText('$'+Math.round(v),x+bW/2,y-7)}
ctx.fillStyle='#5c5c78';ctx.font='500 10px Outfit';ctx.textAlign='center';ctx.fillText(labels[i],x+bW/2,H-8)}
}

function drawDonut(me){
var c=document.getElementById('donut-chart'),dpr=window.devicePixelRatio||1;
c.width=200*dpr;c.height=200*dpr;var ctx=c.getContext('2d');ctx.scale(dpr,dpr);
var sz=200,cx=sz/2,cy=sz/2,oR=88,iR=58;ctx.clearRect(0,0,sz,sz);
var ct={};me.forEach(function(e){ct[e.category]=(ct[e.category]||0)+Number(e.amount)});
var sorted=Object.entries(ct).sort(function(a,b){return b[1]-a[1]}),total=sorted.reduce(function(s,e){return s+e[1]},0);
document.getElementById('donut-total').textContent=fmt(total);
if(total===0){ctx.strokeStyle='rgba(255,255,255,0.06)';ctx.lineWidth=oR-iR;ctx.beginPath();ctx.arc(cx,cy,(oR+iR)/2,0,Math.PI*2);ctx.stroke();document.getElementById('donut-legend').innerHTML='';return}
var a=-Math.PI/2,lg='';
sorted.forEach(function(entry){var catId=entry[0],val=entry[1];var cat=CM[catId]||{emoji:'üì¶',name:catId,color:'#7c6df0'};var col=cat.color;var sl=(val/total)*Math.PI*2;
ctx.beginPath();ctx.moveTo(cx+Math.cos(a)*iR,cy+Math.sin(a)*iR);ctx.arc(cx,cy,oR,a,a+sl);ctx.arc(cx,cy,iR,a+sl,a,true);ctx.closePath();ctx.fillStyle=col;ctx.fill();ctx.strokeStyle='#12121c';ctx.lineWidth=2;ctx.stroke();
lg+='<div class="legend-item"><span class="legend-dot" style="background:'+col+'"></span>'+cat.emoji+' '+Math.round(val/total*100)+'%</div>';a+=sl});
document.getElementById('donut-legend').innerHTML=lg;
}

function drawCatBars(me){
var ct={};me.forEach(function(e){ct[e.category]=(ct[e.category]||0)+Number(e.amount)});
S.fixedExpenses.forEach(function(e){ct[e.category]=(ct[e.category]||0)+Number(e.amount)});
var mx=Math.max.apply(null,Object.values(ct).concat([1])),sorted=Object.entries(ct).sort(function(a,b){return b[1]-a[1]});
var el=document.getElementById('category-breakdown');
if(!sorted.length){el.innerHTML='<div class="empty-state"><div class="emoji">üì≠</div><p>No expenses yet.<br>Tap + to start!</p></div>';return}
el.innerHTML=sorted.map(function(entry){var id=entry[0],t=entry[1];var c=CM[id]||{emoji:'üì¶',name:id,color:'#7c6df0'};return'<div class="cat-row"><span class="cat-emoji">'+c.emoji+'</span><div class="cat-info"><div class="cat-name">'+c.name+'</div><div class="cat-bar-track"><div class="cat-bar-fill" style="width:'+t/mx*100+'%;background:'+c.color+'"></div></div></div><span class="cat-amount">'+fmt(t)+'</span></div>'}).join('');
}

function drawComparison(curMonthExps,curVarTotal){
var el=document.getElementById('mom-comparison');
var now=new Date();
var prevDate=new Date(now.getFullYear(),now.getMonth()-1,1);
var prevYm=prevDate.getFullYear()+'-'+String(prevDate.getMonth()+1).padStart(2,'0');
var prevMonthName=prevDate.toLocaleDateString('en-SG',{month:'short'});
var curMonthName=now.toLocaleDateString('en-SG',{month:'short'});

// Get previous month expenses
var prevExps=S.expenses.filter(function(e){return e.date&&e.date.startsWith(prevYm)});
var prevVarTotal=prevExps.reduce(function(s,e){return s+Number(e.amount)},0);

if(prevVarTotal===0&&curVarTotal===0){
el.innerHTML='<div class="mom-card"><div class="mom-no-data">No data to compare yet. Start tracking to see month-over-month insights.</div></div>';
return;
}

// Overall change
var overallPct=prevVarTotal>0?((curVarTotal-prevVarTotal)/prevVarTotal*100):100;
var overallDir=overallPct>1?'up':overallPct<-1?'down':'flat';
var overallSign=overallPct>0?'+':'';
var overallIcon=overallDir==='up'?'‚Üë':overallDir==='down'?'‚Üì':'‚Üí';

// Category breakdown
var curCats={},prevCats={},allCatIds={};
curMonthExps.forEach(function(e){curCats[e.category]=(curCats[e.category]||0)+Number(e.amount);allCatIds[e.category]=true});
prevExps.forEach(function(e){prevCats[e.category]=(prevCats[e.category]||0)+Number(e.amount);allCatIds[e.category]=true});

var catRows=Object.keys(allCatIds).map(function(catId){
var cur=curCats[catId]||0;
var prev=prevCats[catId]||0;
var pct=prev>0?((cur-prev)/prev*100):(cur>0?100:0);
var diff=cur-prev;
return{catId:catId,cur:cur,prev:prev,pct:pct,diff:diff,absDiff:Math.abs(diff)};
});

// Sort by biggest absolute change
catRows.sort(function(a,b){return b.absDiff-a.absDiff});

// Find max value for bar scaling
var maxVal=Math.max.apply(null,catRows.map(function(r){return Math.max(r.cur,r.prev)}).concat([1]));

var html='<div class="mom-card">';

// Header with overall comparison
html+='<div class="mom-header">';
html+='<div class="mom-header-left">';
html+='<div class="mom-total">'+fmt(curVarTotal)+'</div>';
html+='<div class="mom-label">'+curMonthName+' variable spending</div>';
html+='</div>';
html+='<div class="mom-badge '+overallDir+'">'+overallIcon+' '+overallSign+Math.round(Math.abs(overallPct))+'%</div>';
html+='</div>';

// Category rows
catRows.forEach(function(row){
var cat=CM[row.catId]||{emoji:'üì¶',name:row.catId,color:'#7c6df0'};
var pctDir=row.pct>2?'up':row.pct<-2?'down':'';
var isNew=row.prev===0&&row.cur>0;
var pctLabel='';
if(isNew){pctLabel='<span class="mom-row-pct new">NEW</span>'}
else if(Math.abs(row.pct)>2){pctLabel='<span class="mom-row-pct '+pctDir+'">'+(row.pct>0?'+':'')+Math.round(row.pct)+'%</span>'}

html+='<div class="mom-row">';
html+='<span class="mom-row-emoji">'+cat.emoji+'</span>';
html+='<div class="mom-row-info">';
html+='<div class="mom-row-name">'+cat.name+'</div>';
html+='<div class="mom-row-bar">';
html+='<div class="mom-bar-cur" style="width:'+Math.max(row.cur/maxVal*100,1)+'%;background:'+cat.color+'"></div>';
html+='</div>';
html+='</div>';
html+='<div class="mom-row-amounts">';
html+='<div class="mom-row-cur">'+fmt(row.cur)+pctLabel+'</div>';
html+='<div class="mom-row-prev">'+prevMonthName+': '+fmt(row.prev)+'</div>';
html+='</div>';
html+='</div>';
});

html+='</div>';
el.innerHTML=html;
}

var amtStr='',selCat='',dateMode='today';
function resetAdd(){amtStr='';selCat='';dateMode='today';updAmt();document.getElementById('desc-input').value='';document.getElementById('custom-date').style.display='none';document.querySelectorAll('.date-btn').forEach(function(b){b.classList.remove('selected')});document.getElementById('date-today').classList.add('selected');renderCatGrid()}
function renderCatGrid(){document.getElementById('category-grid').innerHTML=CATS.map(function(c){return'<button class="cat-btn '+(selCat===c.id?'selected':'')+'" onclick="pickCat(\''+c.id+'\')"><span class="emoji">'+c.emoji+'</span>'+c.name.split(/[\s\/&]/)[0]+'</button>'}).join('')}
function pickCat(id){selCat=id;renderCatGrid()}
function numInput(ch){if(ch==='.'&&amtStr.includes('.'))return;if(amtStr.includes('.')&&amtStr.split('.')[1].length>=2)return;if(amtStr.length>=10)return;amtStr+=ch;updAmt()}
function numDelete(){amtStr=amtStr.slice(0,-1);updAmt()}
function updAmt(){var el=document.getElementById('amount-display');if(!amtStr){el.textContent='0.00';el.classList.add('empty')}else{el.textContent=amtStr;el.classList.remove('empty')}}
function selectDate(m){dateMode=m;document.querySelectorAll('.date-btn').forEach(function(b){b.classList.remove('selected')});document.getElementById('date-'+m).classList.add('selected');document.getElementById('custom-date').style.display=m==='custom'?'block':'none';if(m==='custom')document.getElementById('custom-date').value=today()}
function getDate(){if(dateMode==='today')return today();if(dateMode==='yesterday'){var d=new Date();d.setDate(d.getDate()-1);return d.toISOString().split('T')[0]}return document.getElementById('custom-date').value||today()}
function saveExpense(){var a=parseFloat(amtStr);if(!a||a<=0)return toast('Enter an amount',1);if(!selCat)return toast('Pick a category',1);var e={id:Date.now()+'',amount:a,category:selCat,description:document.getElementById('desc-input').value.trim(),date:getDate(),type:'variable',createdAt:new Date().toISOString()};S.expenses.push(e);save();syncOne(e);toast('‚úì Saved '+fmt(a));showScreen('dashboard')}

var hFilter='all';
function refreshHist(){
document.getElementById('history-month-label').textContent=monthLabel();
document.getElementById('history-filters').innerHTML=[{id:'all',name:'All'},{id:'fixed',name:'Fixed'}].concat(CATS).map(function(c){return'<button class="filter-tab '+(hFilter===c.id?'active':'')+'" onclick="setHF(\''+c.id+'\')">'+c.name.split(/[\s\/&]/)[0]+'</button>'}).join('');
var el=document.getElementById('history-list');var items=[];
if(hFilter==='all'||hFilter==='fixed')S.fixedExpenses.forEach(function(e){var o=Object.assign({},e);o.type='fixed';o.date=today().slice(0,8)+String(e.due||1).padStart(2,'0');items.push(o)});
monthExps().forEach(function(e){if(hFilter==='all'||hFilter===e.category)items.push(e)});
if(hFilter==='fixed')items=items.filter(function(e){return e.type==='fixed'});
items.sort(function(a,b){return b.date>a.date?1:b.date<a.date?-1:0});
if(!items.length){el.innerHTML='<div class="empty-state"><div class="emoji">üîç</div><p>No expenses found.</p></div>';return}
el.innerHTML=items.map(function(e){var c=CM[e.category]||{emoji:'üì¶',name:e.category};var ds=new Date(e.date+'T00:00:00').toLocaleDateString('en-SG',{day:'numeric',month:'short'});var f=e.type==='fixed';
return'<div class="expense-item"><span class="expense-emoji">'+c.emoji+'</span><div class="expense-info"><div class="expense-name">'+(e.description||e.name||c.name)+'</div><div class="expense-meta">'+ds+' ¬∑ '+c.name+(f?' ¬∑ Fixed':'')+'</div></div><span class="expense-amount'+(f?' fixed':'')+'">'+fmt(e.amount)+'</span>'+(!f?'<div class="expense-actions"><button onclick="editExp(\''+e.id+'\')" aria-label="Edit">‚úèÔ∏è</button><button onclick="delExp(\''+e.id+'\')" aria-label="Delete">üóëÔ∏è</button></div>':'')+'</div>'}).join('')}
function setHF(id){hFilter=id;refreshHist()}

var editId=null;
function editExp(id){var e=S.expenses.find(function(x){return x.id===id});if(!e)return;editId=id;document.getElementById('em-amount').value=e.amount;document.getElementById('em-desc').value=e.description||'';document.getElementById('em-cat').innerHTML=CATS.map(function(c){return'<option value="'+c.id+'" '+(c.id===e.category?'selected':'')+'>'+c.emoji+' '+c.name+'</option>'}).join('');document.getElementById('edit-modal').classList.add('show')}
function saveEdit(){var e=S.expenses.find(function(x){return x.id===editId});if(!e)return;e.amount=parseFloat(document.getElementById('em-amount').value)||e.amount;e.description=document.getElementById('em-desc').value.trim();e.category=document.getElementById('em-cat').value;save();closeModal('edit-modal');refreshHist();toast('‚úì Updated')}
function delExp(id){if(!confirm('Delete this expense?'))return;S.expenses=S.expenses.filter(function(e){return e.id!==id});save();refreshHist();toast('Deleted')}

function refreshSet(){document.getElementById('income-input').value=S.income||'';document.getElementById('sheets-url').value=S.sheetsUrl||'';updSheetStat();renderFixed()}
function saveSettings(){S.income=parseFloat(document.getElementById('income-input').value)||0;save()}
function renderFixed(){var el=document.getElementById('fixed-expenses-list');if(!S.fixedExpenses.length){el.innerHTML='<div style="padding:16px;text-align:center;color:var(--text3);font-size:13px">No fixed expenses yet.</div>';return}
el.innerHTML=S.fixedExpenses.map(function(e,i){var c=CM[e.category]||{emoji:'üì¶',name:e.category};return'<div class="fixed-expense-item" onclick="editFix('+i+')"><span style="font-size:20px">'+c.emoji+'</span><div class="fixed-expense-info"><div class="fixed-expense-name">'+e.name+'</div><div class="fixed-expense-detail">Due: '+(e.due||'‚Äî')+' ¬∑ '+c.name+'</div></div><span class="fixed-expense-amount">'+fmt(e.amount)+'</span></div>'}).join('')}

var fixIdx=-1;
function showFixedModal(i){fixIdx=typeof i==='number'?i:-1;var ed=fixIdx>=0;document.getElementById('fm-title').textContent=ed?'Edit Fixed Expense':'Add Fixed Expense';document.getElementById('fm-save').textContent=ed?'Save':'Add';document.getElementById('fm-del').style.display=ed?'block':'none';document.getElementById('fm-cat').innerHTML=CATS.map(function(c){return'<option value="'+c.id+'">'+c.emoji+' '+c.name+'</option>'}).join('');if(ed){var e=S.fixedExpenses[i];document.getElementById('fm-name').value=e.name;document.getElementById('fm-amount').value=e.amount;document.getElementById('fm-cat').value=e.category;document.getElementById('fm-due').value=e.due||''}else{document.getElementById('fm-name').value='';document.getElementById('fm-amount').value='';document.getElementById('fm-due').value=''}document.getElementById('fixed-modal').classList.add('show')}
function editFix(i){showFixedModal(i)}
function saveFixed(){var n=document.getElementById('fm-name').value.trim(),a=parseFloat(document.getElementById('fm-amount').value),c=document.getElementById('fm-cat').value,d=parseInt(document.getElementById('fm-due').value)||1;if(!n)return toast('Enter a name',1);if(!a)return toast('Enter an amount',1);var e={name:n,amount:a,category:c,due:d};if(fixIdx>=0)S.fixedExpenses[fixIdx]=e;else S.fixedExpenses.push(e);save();closeModal('fixed-modal');refreshSet();toast(fixIdx>=0?'‚úì Updated':'‚úì Added')}
function deleteFixed(){if(fixIdx<0)return;if(!confirm('Delete?'))return;S.fixedExpenses.splice(fixIdx,1);save();closeModal('fixed-modal');refreshSet();toast('Deleted')}

var pending=[];
function handleCSV(ev){
var f=ev.target.files[0];if(!f)return;
var rd=new FileReader();rd.onload=function(e){
var lines=e.target.result.trim().split('\n');pending=[];var skip=0;
var h=lines[0].toLowerCase(),hasH=h.includes('date')||h.includes('amount');
for(var i=hasH?1:0;i<lines.length;i++){
var cols=parseCSVLine(lines[i].trim());if(cols.length<2){skip++;continue}
var ds=cols[0].trim().replace(/"/g,'');var amt=parseFloat(cols[1].replace(/[^0-9.\-]/g,''));if(!amt||isNaN(amt)){skip++;continue}
ds=parseD(ds);if(!ds){skip++;continue}
var raw=(cols[2]||'').trim().replace(/"/g,'').toLowerCase();var cid='food';
for(var ci=0;ci<CATS.length;ci++){var c=CATS[ci];var clow=c.name.toLowerCase(),cwords=clow.split(/[\s\/&]+/);if(raw===c.id||raw===clow||cwords.indexOf(raw)>=0||raw.includes(c.id)||c.id.includes(raw)||clow.includes(raw)||raw.includes(cwords[0])){cid=c.id;break}}
pending.push({id:Date.now()+'-'+i,amount:Math.abs(amt),category:cid,description:(cols[3]||'').trim().replace(/"/g,''),date:ds,type:'variable',createdAt:new Date().toISOString()})
}
var pv=document.getElementById('upload-preview'),ib=document.getElementById('import-btn');
if(pending.length){pv.style.display='block';ib.style.display='block';
var html='<span style="color:var(--green);font-weight:600">‚úì '+pending.length+' expenses found</span>';
if(skip)html+=' <span style="color:var(--orange)">('+skip+' skipped)</span>';html+='<br><br>';
pending.slice(0,5).forEach(function(e){var c=CM[e.category]||{emoji:'üì¶'};html+='<div style="padding:4px 0;border-bottom:1px solid var(--border);display:flex;justify-content:space-between"><span>'+c.emoji+' '+e.date+'</span><span style="color:var(--red)">'+fmt(e.amount)+'</span></div>'});
if(pending.length>5)html+='<div style="padding:8px 0;color:var(--text3)">...and '+(pending.length-5)+' more</div>';pv.innerHTML=html
}else{pv.style.display='block';ib.style.display='none';pv.innerHTML='<span style="color:var(--red)">No valid rows found ('+skip+' skipped).</span><br><span style="color:var(--text3)">Expected: Date, Amount, Category, Description</span>'}
};rd.readAsText(f);ev.target.value=''}
function parseCSVLine(l){var r=[];var c='',q=false;for(var i=0;i<l.length;i++){var ch=l[i];if(ch==='"')q=!q;else if(ch===','&&!q){r.push(c);c=''}else c+=ch}r.push(c);return r}
function parseD(s){
if(/^\d{4}-\d{1,2}-\d{1,2}$/.test(s)){var p=s.split('-');return p[0]+'-'+p[1].padStart(2,'0')+'-'+p[2].padStart(2,'0')}
if(/^\d{1,2}\/\d{1,2}\/\d{2,4}$/.test(s)){var p=s.split('/'),y=p[2];if(y.length===2)y=(parseInt(y)>50?'19':'20')+y;return y+'-'+p[1].padStart(2,'0')+'-'+p[0].padStart(2,'0')}
if(/^\d{1,2}-\d{1,2}-\d{2,4}$/.test(s)){var p=s.split('-'),y=p[2];if(y.length===2)y=(parseInt(y)>50?'19':'20')+y;return y+'-'+p[1].padStart(2,'0')+'-'+p[0].padStart(2,'0')}
return null}
function confirmImport(){if(!pending.length)return;if(!confirm('Import '+pending.length+' expenses?'))return;
var added=0,skipped=0;
pending.forEach(function(p){var isDup=S.expenses.some(function(e){return e.date===p.date&&Number(e.amount)===Number(p.amount)&&e.category===p.category&&(e.description||'')===(p.description||'')});if(!isDup){S.expenses.push(p);added++}else{skipped++}});
save();var msg='‚úì '+added+' imported!';if(skipped>0)msg+=' ('+skipped+' duplicates skipped)';
toast(msg);pending=[];document.getElementById('upload-preview').style.display='none';document.getElementById('import-btn').style.display='none';if(S.sheetsUrl)syncAll()}

function saveSheetsUrl(){S.sheetsUrl=document.getElementById('sheets-url').value.trim();save();updSheetStat()}
function updSheetStat(){var el=document.getElementById('sheets-status');el.textContent=S.sheetsUrl?'üü¢ Connected':'‚ö™ Not connected';el.className='sheets-status '+(S.sheetsUrl?'connected':'disconnected')}
async function post(p){if(!S.sheetsUrl)return;try{await fetch(S.sheetsUrl,{method:'POST',mode:'no-cors',headers:{'Content-Type':'text/plain'},body:JSON.stringify(p)});return true}catch(e){return false}}
function syncOne(e){var c=CM[e.category]||{name:e.category};post({action:'addExpense',date:e.date,amount:e.amount,category:c.name,description:e.description||'',type:e.type||'variable'})}
async function testSheets(){if(!S.sheetsUrl)return toast('Enter URL first',1);toast('Testing...');await post({action:'test'});toast('Request sent! Check your sheet.')}
async function syncAll(){if(!S.sheetsUrl)return toast('Enter URL first',1);toast('Syncing...');for(var i=0;i<S.fixedExpenses.length;i++){var e=S.fixedExpenses[i];var c=CM[e.category]||{name:e.category};await post({action:'addExpense',date:today(),amount:e.amount,category:c.name,description:e.name+' (Fixed)',type:'fixed'})}for(var i=0;i<S.expenses.length;i++){var e=S.expenses[i];var c=CM[e.category]||{name:e.category};await post({action:'addExpense',date:e.date,amount:e.amount,category:c.name,description:e.description||'',type:'variable'})}toast('‚úì All synced!')}
function exportCSV(){var csv='Date,Amount,Category,Description,Type\n';S.fixedExpenses.forEach(function(e){var c=CM[e.category]||{name:e.category};csv+=today()+','+e.amount+',"'+c.name+'","'+e.name+'",fixed\n'});S.expenses.forEach(function(e){var c=CM[e.category]||{name:e.category};csv+=e.date+','+e.amount+',"'+c.name+'","'+(e.description||'')+'",variable\n'});var b=new Blob([csv],{type:'text/csv'}),u=URL.createObjectURL(b),a=document.createElement('a');a.href=u;a.download='spendwise-'+today()+'.csv';a.click();URL.revokeObjectURL(u);toast('‚úì Exported')}
function clearData(){if(!confirm('Delete ALL data?'))return;if(!confirm('Really?'))return;localStorage.removeItem('sw');S={income:0,fixedExpenses:[],expenses:[],sheetsUrl:''};refreshSet();toast('Cleared')}

load();renderCatGrid();
setTimeout(function(){refreshDash()},80);
document.querySelectorAll('.modal-overlay').forEach(function(m){m.addEventListener('click',function(e){if(e.target===m)m.classList.remove('show')})});
window.addEventListener('resize',function(){if(curScreen==='dashboard')drawTrend()});
</script>
</body>
</html>
